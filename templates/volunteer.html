{% extends "base.html" %}
{% block title %}Send Help{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Clean map styling without aggressive overrides */
    #map {
      height: 400px;
      width: 100%;
      border: 2px solid #007bff;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    /* Ensure Leaflet images display correctly */
    .leaflet-container img {
      max-width: none !important;
    }
    
    #mapStatus {
      padding: 10px;
      background: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 4px;
      margin-top: 10px;
      font-weight: bold;
    }
    
    .map-container {
      width: 100%;
      margin: 20px 0;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Request Help</h1>

    <!-- Help Request Section -->
    <div style="margin-top: 20px;">
        <button id="sendHelpBtn" class="btn btn-primary">Send Help (Share Location)</button>
        <a href="{{ url_for('volunteer.register_volunteer') }}" class="btn btn-success">Register as Volunteer</a>
        <p id="status">Click the button above to share your location and request help.</p>
    </div>

    <form id="helpForm" method="POST" action="{{ url_for('volunteer.volunteer_request') }}" style="display:none;">
        <input type="hidden" name="lat" id="latInput" required>
        <input type="hidden" name="lng" id="lngInput" required>
        <input type="hidden" name="title" value="Help Request">
        <input type="hidden" name="description" value="User requested help">
    </form>

    <!-- Map Section -->
    <div class="map-container">
        <h2>Current Help Requests</h2>
        <div id="map"></div>
        <p id="mapStatus">Loading map...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Page loaded, initializing...');
      
      // Initialize elements
      const sendHelpBtn = document.getElementById('sendHelpBtn');
      const status = document.getElementById('status');
      const latInput = document.getElementById('latInput');
      const lngInput = document.getElementById('lngInput');
      const helpForm = document.getElementById('helpForm');
      const mapStatus = document.getElementById('mapStatus');

      // Help request functionality
      if (sendHelpBtn) {
          sendHelpBtn.addEventListener('click', function(e) {
              e.preventDefault();
              
              if (!navigator.geolocation) {
                  status.textContent = "Geolocation is not supported by your browser.";
                  status.style.color = "red";
                  return;
              }
              
              status.textContent = "Getting your location...";
              status.style.color = "blue";
              
              navigator.geolocation.getCurrentPosition(
                  function(pos) {
                      const lat = pos.coords.latitude.toFixed(6);
                      const lng = pos.coords.longitude.toFixed(6);
                      latInput.value = lat;
                      lngInput.value = lng;
                      status.textContent = `Location found: (${lat}, ${lng}). Sending help request...`;
                      status.style.color = "green";
                      helpForm.submit();
                  },
                  function(error) {
                      status.textContent = "Unable to get your location. Error: " + error.message;
                      status.style.color = "red";
                  }
              );
          });
      }

      // Map initialization - simplified and robust
      console.log('üó∫Ô∏è Starting map initialization...');
      
      // Check if Leaflet is available
      if (typeof L === 'undefined') {
          console.error('‚ùå Leaflet library not loaded');
          mapStatus.textContent = "Error: Leaflet library not loaded";
          mapStatus.style.color = "red";
          return;
      }
      
      // Wait for DOM to be fully ready
      setTimeout(function() {
          try {
              console.log('üó∫Ô∏è Creating Leaflet map...');
              mapStatus.textContent = "Creating map...";
              
              // Get map container
              const mapContainer = document.getElementById('map');
              if (!mapContainer) {
                  throw new Error('Map container not found');
              }
              
              console.log('üìè Map container dimensions:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
              
              // Create map with Singapore center
              const map = L.map('map', {
                  center: [1.3521, 103.8198],
                  zoom: 11,
                  zoomControl: true
              });
              
              console.log('üó∫Ô∏è Map object created successfully');
              mapStatus.textContent = "Adding map tiles...";
              
              // Add tile layer
              const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '¬© OpenStreetMap contributors',
                  maxZoom: 19
              });
              
              tileLayer.addTo(map);
              
              // Add event listeners for tile loading
              tileLayer.on('loading', function() {
                  console.log('üîÑ Tiles loading...');
                  mapStatus.textContent = "Loading map tiles...";
              });
              
              tileLayer.on('load', function() {
                  console.log('‚úÖ Tiles loaded successfully!');
                  mapStatus.textContent = "Map loaded successfully!";
                  mapStatus.style.color = "green";
              });
              
              // Add test marker
              const testMarker = L.marker([1.3521, 103.8198]).addTo(map);
              testMarker.bindPopup("<b>Singapore</b><br>Map is working!").openPopup();
              
              console.log('üó∫Ô∏è Test marker added');
              
              // Force map resize after short delay
              setTimeout(function() {
                  map.invalidateSize();
                  console.log('üîÑ Map size invalidated');
              }, 100);
              
              // Load volunteer requests
              loadVolunteerRequests(map);
              
          } catch (error) {
              console.error('‚ùå Map initialization error:', error);
              mapStatus.textContent = "Map Error: " + error.message;
              mapStatus.style.color = "red";
              
              // Show fallback message
              document.getElementById('map').innerHTML = 
                  '<div style="display: flex; align-items: center; justify-content: center; height: 400px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px;">' +
                  '<div style="text-align: center; color: #6c757d;">' +
                  '<h4>Map Unavailable</h4>' +
                  '<p>Error: ' + error.message + '</p>' +
                  '<p>Check browser console for details</p>' +
                  '</div></div>';
          }
      }, 500);

      // Function to load volunteer requests
      function loadVolunteerRequests(map) {
          console.log('üì• Loading volunteer requests...');
          
          fetch('{{ url_for("volunteer.volunteer_requests_json") }}')
              .then(response => {
                  console.log('üì° Response received:', response.status);
                  if (!response.ok) {
                      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                  }
                  return response.json();
              })
              .then(data => {
                  console.log('üìã Received volunteer requests:', data);
                  
                  if (!Array.isArray(data)) {
                      throw new Error('Invalid data format received');
                  }
                  
                  if (data.length === 0) {
                      mapStatus.textContent = "Map loaded - No help requests currently active.";
                      mapStatus.style.color = "blue";
                  } else {
                      mapStatus.textContent = `Map loaded - Showing ${data.length} help request(s).`;
                      mapStatus.style.color = "green";
                      
                      // Add markers for each request
                      data.forEach(function(request, index) {
                          if (request.lat && request.lng) {
                              console.log(`üìç Adding marker ${index + 1}:`, request.title);
                              
                              const marker = L.marker([request.lat, request.lng]).addTo(map);
                              
                              let popupContent = `<strong>${request.title}</strong><br>${request.description}`;
                              if (request.requester) {
                                  popupContent += `<br><small><em>By: ${request.requester}</em></small>`;
                              }
                              
                              marker.bindPopup(popupContent);
                          }
                      });
                  }
              })
              .catch(error => {
                  console.error('‚ùå Error loading volunteer requests:', error);
                  mapStatus.textContent = "Map loaded - Error loading help requests: " + error.message;
                  mapStatus.style.color = "orange";
              });
      }
  });
  </script>
{% endblock %}