{% extends "base.html" %}
{% block title %}Send Help{% endblock %}

{% block content %}
<h1>Request Help</h1>

<!-- Help Request Section -->
<div class="mt-3">
  <button id="sendHelpBtn" class="btn btn-primary">Send Help (Share Location)</button>
  <a href="{{ url_for('volunteer.register_volunteer') }}" class="btn btn-success ms-2">Register as Volunteer</a>
  <p id="status" class="text-muted mt-2"></p>
</div>
<form id="helpForm" method="POST" action="{{ url_for('volunteer.volunteer_request') }}" style="display:none;">
  <input type="hidden" name="lat" id="latInput" required>
  <input type="hidden" name="lng" id="lngInput" required>
  <input type="hidden" name="title" value="Help Request">
  <input type="hidden" name="description" value="User requested help">
</form>

<!-- Map Section -->
<div class="mt-4">
  <h2>Current Help Requests</h2>
  <div id="map"></div>
  <p id="mapStatus" class="text-muted mt-2">Loading help requests...</p>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* Page-specific CSS */
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    #sendHelpBtn {
      margin-bottom: 10px;
    }

    #map {
      height: 400px;
      width: 100%;
      border: 2px solid #ccc;
      border-radius: 6px;
      margin-top: 15px;
    }

    #status, #mapStatus {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing...');
      
      const sendHelpBtn = document.getElementById('sendHelpBtn');
      const status = document.getElementById('status');
      const latInput = document.getElementById('latInput');
      const lngInput = document.getElementById('lngInput');
      const helpForm = document.getElementById('helpForm');

      if (sendHelpBtn) {
        sendHelpBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (!navigator.geolocation) {
            status.textContent = "Geolocation is not supported by your browser.";
            return;
          }
          status.textContent = "Locatingâ€¦ please allow location access.";
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const lat = pos.coords.latitude.toFixed(6);
              const lng = pos.coords.longitude.toFixed(6);
              latInput.value = lat;
              lngInput.value = lng;
              status.textContent = `Location found: (${lat}, ${lng}). Sending help request...`;
              helpForm.submit();
            },
            (error) => {
              status.textContent = "Unable to retrieve your location. Error: " + error.message;
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
          );
        });
      }

      let map = L.map('map').setView([1.3521, 103.8198], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      const mapStatus = document.getElementById('mapStatus');
      fetch('{{ url_for("volunteer.volunteer_requests_json") }}')
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            mapStatus.textContent = "No help requests currently active.";
          } else {
            mapStatus.textContent = `Showing ${data.length} help request(s).`;
            data.forEach(req => {
              if (req.lat && req.lng) {
                const marker = L.marker([req.lat, req.lng]).addTo(map);
                let popupContent = `<b>${req.title}</b><br>${req.description}`;
                if (req.claimed_by) popupContent += `<br><small class="text-muted">Claimed by: ${req.claimed_by}</small>`;
                if (req.requester) popupContent += `<br><small class="text-info">Requested by: ${req.requester}</small>`;
                marker.bindPopup(popupContent);
              }
            });
          }
        })
        .catch(error => {
          mapStatus.textContent = "Error loading help requests: " + error.message;
        });
    });
  </script>
{% endblock %}
