{% extends "base.html" %}
{% block title %}Send Help{% endblock %}

{% block content %}
<h1>Request Help</h1>

<!-- Help Request Section -->
<div class="mt-3">
  <button id="sendHelpBtn" class="btn btn-primary">Send Help (Share Location)</button>
  <a href="{{ url_for('volunteer.register_volunteer') }}" class="btn btn-success ms-2">Register as Volunteer</a>
  <p id="status" class="text-muted mt-2"></p>
</div>
<form id="helpForm" method="POST" action="{{ url_for('volunteer.volunteer_request') }}" style="display:none;">
  <input type="hidden" name="lat" id="latInput" required>
  <input type="hidden" name="lng" id="lngInput" required>
  <input type="hidden" name="title" value="Help Request">
  <input type="hidden" name="description" value="User requested help">
</form>

<!-- Map Section -->
<div class="mt-4">
  <h2>Current Help Requests</h2>
  <div id="map" style="height: 400px; width: 100%; border: 1px solid #ccc; margin-top: 15px;"></div>
  <p id="mapStatus" class="text-muted mt-2">Loading help requests...</p>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing...');
      
      // Help request functionality - KEEPING ORIGINAL
      const sendHelpBtn = document.getElementById('sendHelpBtn');
      const status = document.getElementById('status');
      const latInput = document.getElementById('latInput');
      const lngInput = document.getElementById('lngInput');
      const helpForm = document.getElementById('helpForm');

      console.log('Elements found:', {
        sendHelpBtn: !!sendHelpBtn,
        status: !!status,
        latInput: !!latInput,
        lngInput: !!lngInput,
        helpForm: !!helpForm
      });

      if (sendHelpBtn) {
        sendHelpBtn.addEventListener('click', (e) => {
          console.log('Send help button clicked');
          e.preventDefault();
          
          if (!navigator.geolocation) {
            status.textContent = "Geolocation is not supported by your browser.";
            console.log('Geolocation not supported');
            return;
          }
          
          status.textContent = "Locatingâ€¦ please allow location access.";
          console.log('Requesting geolocation...');
          
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              console.log('Location found:', pos.coords);
              const lat = pos.coords.latitude.toFixed(6);
              const lng = pos.coords.longitude.toFixed(6);
              latInput.value = lat;
              lngInput.value = lng;
              status.textContent = `Location found: (${lat}, ${lng}). Sending help request...`;
              console.log('Submitting form...');
              helpForm.submit();
            },
            (error) => {
              console.error('Geolocation error:', error);
              status.textContent = "Unable to retrieve your location. Error: " + error.message;
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 60000
            }
          );
        });
      }

      // Map functionality - KEEPING ORIGINAL with backend integration
      console.log('Initializing map...');
      let map;
      try {
        map = L.map('map').setView([1.3521, 103.8198], 11);
        console.log('Map created successfully');
      } catch (error) {
        console.error('Error creating map:', error);
        document.getElementById('mapStatus').textContent = "Error initializing map: " + error.message;
        return;
      }

      const markers = {};
      const mapStatus = document.getElementById('mapStatus');

      try {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
        console.log('Tile layer added');
      } catch (error) {
        console.error('Error adding tile layer:', error);
        mapStatus.textContent = "Error loading map tiles: " + error.message;
      }

      function addMarker(request) {
        try {
          console.log('Adding marker for request:', request);
          const marker = L.marker([request.lat, request.lng]).addTo(map);
          
          // Simple popup without action buttons - just shows information
          let popupContent = `<b>${request.title}</b><br>${request.description}`;
          if (request.claimed_by) {
            popupContent += `<br><small class="text-muted">Claimed by: ${request.claimed_by}</small>`;
          }
          // Add requester info
          if (request.requester) {
            popupContent += `<br><small class="text-info">Requested by: ${request.requester}</small>`;
          }
          marker.bindPopup(popupContent);
          markers[request.id] = marker;
          console.log('Marker added successfully');
        } catch (error) {
          console.error('Error adding marker:', error);
        }
      }

      // Load and display help requests - KEEPING ORIGINAL with updated endpoint
      console.log('Fetching help requests...');
      const requestsUrl = '{{ url_for("volunteer.volunteer_requests_json") }}';
      console.log('Requests URL:', requestsUrl);
      
      fetch(requestsUrl)
        .then(res => {
          console.log('Response status:', res.status);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          return res.json();
        })
        .then(data => {
          console.log('Received data:', data);
          if (!Array.isArray(data)) {
            throw new Error('Invalid data format received');
          }
          
          if (data.length === 0) {
            mapStatus.textContent = "No help requests currently active.";
          } else {
            mapStatus.textContent = `Showing ${data.length} help request(s).`;
            data.forEach(req => {
              if (req.lat && req.lng) {
                addMarker(req);
              } else {
                console.warn('Request missing coordinates:', req);
              }
            });
          }
        })
        .catch(error => {
          console.error('Error fetching requests:', error);
          mapStatus.textContent = "Error loading help requests: " + error.message;
        });
    });
  </script>
{% endblock %}