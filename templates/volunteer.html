{% extends "base.html" %}

{% block title %}Volunteer Requests Map{% endblock %}

{% block content %}
<h1>Volunteer Requests Map</h1>

<div id="map" style="height: 400px; width: 100%;"></div>

<div id="help-section" class="mt-3">
  <button id="openHelpBtn" class="btn btn-primary" disabled>Send Help</button>
  <p id="locationStatus" class="text-muted small mt-2"></p>
</div>

<!-- Modal -->
<div id="helpModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="helpForm" method="POST" action="{{ url_for('volunteer_map') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Send Help Location</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeModalBtn">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="request_id" id="request_id" />
          <div class="form-group">
            <label for="lat">Latitude</label>
            <input type="text" readonly required pattern="^-?\d+(\.\d+)?$" class="form-control" name="lat" id="lat" />
          </div>
          <div class="form-group">
            <label for="lng">Longitude</label>
            <input type="text" readonly required pattern="^-?\d+(\.\d+)?$" class="form-control" name="lng" id="lng" />
          </div>
          <p id="locationStatusModal" class="text-muted small"></p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Submit</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  <script>
    let map;
    let selectedRequestId = null;
    const openHelpBtn = document.getElementById('openHelpBtn');
    const helpModal = $('#helpModal');  // Use Bootstrap's jQuery modal
    const requestIdInput = document.getElementById('request_id');
    const latInput = document.getElementById('lat');
    const lngInput = document.getElementById('lng');
    const locationStatus = document.getElementById('locationStatus');
    const locationStatusModal = document.getElementById('locationStatusModal');

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 11,
        center: { lat: 1.3521, lng: 103.8198 }, // Singapore center example
      });

      fetch('{{ url_for("volunteer_requests_json") }}')
        .then(response => response.json())
        .then(data => {
          data.forEach(request => {
            if (request.lat && request.lng) {
              const marker = new google.maps.Marker({
                position: { lat: parseFloat(request.lat), lng: parseFloat(request.lng) },
                map: map,
                title: request.title,
                icon: request.claimed_by ? 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' : 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
              });

              marker.addListener('click', () => {
                selectedRequestId = request.id;
                openHelpBtn.disabled = !!request.claimed_by;
                openHelpBtn.textContent = request.claimed_by ? 'Already Claimed' : 'Send Help for "' + request.title + '"';
                requestIdInput.value = selectedRequestId;
                locationStatus.textContent = '';
              });
            }
          });
        });
    }

    openHelpBtn.addEventListener('click', () => {
      if (!selectedRequestId) return;

      if (!navigator.geolocation) {
        locationStatus.textContent = 'Geolocation is not supported by your browser.';
        latInput.value = '';
        lngInput.value = '';
        locationStatusModal.textContent = 'Geolocation not supported. Please enter manually.';
        helpModal.modal('show');
        return;
      }

      locationStatus.textContent = 'Locatingâ€¦ please allow location access.';

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude.toFixed(6);
          const lng = position.coords.longitude.toFixed(6);

          latInput.value = lat;
          lngInput.value = lng;
          locationStatus.textContent = `Location found: (${lat}, ${lng})`;
          locationStatusModal.textContent = '';
          helpModal.modal('show');
        },
        (error) => {
          locationStatus.textContent = 'Unable to retrieve your location. Please enter manually.';
          latInput.value = '';
          lngInput.value = '';
          locationStatusModal.textContent = 'Location access denied or unavailable.';
          helpModal.modal('show');
        }
      );
    });

    // Close modal buttons are handled by Bootstrap via data-dismiss attribute
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap">
  </script>
{% endblock %}
