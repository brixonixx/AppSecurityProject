{% extends "base.html" %}

{% block title %}Edit User - Admin - SilverSage{% endblock %}

{% block content %}
<div class="profile-container">
    <h1>Edit User: {{ user.username }}</h1>
    
    <div style="text-align: center; margin-bottom: 30px;">
        <img src="{{ url_for('static', filename='uploads/' + user.profile_picture) }}" 
             alt="Profile Picture" 
             class="profile-picture">
    </div>
    
    <!-- User Actions -->
    <div class="user-actions">
        <form method="POST" action="{{ url_for('admin.reset_user_password', user_id=user.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-warning" 
                    onclick="return confirm('Reset password for this user?')">
                üîë Reset Password
            </button>
        </form>
        
        {% if user.failed_login_attempts >= 5 %}
        <form method="POST" action="{{ url_for('admin.unlock_user', user_id=user.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-success">
                üîì Unlock Account
            </button>
        </form>
        {% endif %}
        
        {% if user.id != current_user.id %}
        <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-danger" 
                    onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.')">
                üóëÔ∏è Delete User
            </button>
        </form>
        {% endif %}
    </div>
    
    <form method="POST" action="" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        
        <!-- Account Information -->
        <h2 style="margin-top: 30px;">Account Information</h2>
        
        <div class="form-group">
            {{ form.username.label }}
            {{ form.username(class="form-control") }}
            {% for error in form.username.errors %}
                <span style="color: var(--danger-color); font-size: 16px;">{{ error }}</span>
            {% endfor %}
        </div>
        
        <div class="form-group">
            {{ form.email.label }}
            {{ form.email(class="form-control") }}
            {% for error in form.email.errors %}
                <span style="color: var(--danger-color); font-size: 16px;">{{ error }}</span>
            {% endfor %}
        </div>
        
        <!-- Personal Information -->
        <h2 style="margin-top: 30px;">Personal Information</h2>
        
        <div class="form-group">
            {{ form.first_name.label }}
            {{ form.first_name(class="form-control") }}
        </div>
        
        <div class="form-group">
            {{ form.last_name.label }}
            {{ form.last_name(class="form-control") }}
        </div>
        
        <div class="form-group">
            {{ form.age.label }}
            {{ form.age(class="form-control") }}
        </div>
        
        <div class="form-group">
            {{ form.contact_number.label }}
            {{ form.contact_number(class="form-control") }}
        </div>
        
        <!-- Account Settings -->
        <h2 style="margin-top: 30px;">Account Settings</h2>
        
        <div class="form-group">
            <label style="font-size: 20px;">
                {{ form.is_admin() }} Administrator Privileges
            </label>
            {% if user.id == current_user.id %}
                <small style="color: #666; display: block;">You cannot remove your own admin privileges.</small>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label style="font-size: 20px;">
                {{ form.is_active() }} Account Active
            </label>
            {% if user.id == current_user.id %}
                <small style="color: #666; display: block;">You cannot deactivate your own account.</small>
            {% endif %}
        </div>
        
        <!-- Account Statistics -->
        <h2 style="margin-top: 30px;">Account Statistics</h2>
        <div class="stats-info">
            <p><strong>Created:</strong> {{ user.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
            <p><strong>Last Login:</strong> 
                {% if user.last_login %}
                    {{ user.last_login.strftime('%B %d, %Y at %I:%M %p') }}
                {% else %}
                    Never
                {% endif %}
            </p>
            <p><strong>Failed Login Attempts:</strong> {{ user.failed_login_attempts }}</p>
            {% if user.account_locked_until %}
                <p style="color: var(--danger-color);"><strong>Account Locked Until:</strong> 
                    {{ user.account_locked_until.strftime('%B %d, %Y at %I:%M %p') }}
                </p>
            {% endif %}
        </div>
        
        <div class="form-group" style="margin-top: 30px;">
            {{ form.submit(class="btn btn-primary", value="Save Changes") }}
            <a href="{{ url_for('admin.user_list') }}" class="btn btn-secondary" style="margin-left: 10px;">
                Cancel
            </a>
        </div>
    </form>
</div>

<style>
.user-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 30px;
    padding: 20px;
    background: var(--light-bg);
    border-radius: 8px;
}

.stats-info {
    background: var(--light-bg);
    padding: 20px;
    border-radius: 8px;
    margin-top: 15px;
}

.stats-info p {
    margin: 10px 0;
    font-size: 18px;
}
</style>

<script>
// Disable admin/active checkboxes if editing self
document.addEventListener('DOMContentLoaded', function() {
    const userId = {{ user.id }};
    const currentUserId = {{ current_user.id }};
    
    if (userId === currentUserId) {
        document.querySelector('input[name="is_admin"]').disabled = true;
        document.querySelector('input[name="is_active"]').disabled = true;
    }
});
</script>
{% endblock %}