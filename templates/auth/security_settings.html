{% extends "base.html" %}

{% block title %}Security Settings - SilverSage{% endblock %}

{% block content %}
<div class="security-container">
    <h1>🔐 Security Settings</h1>
    <p class="security-subtitle">Manage your account security and two-factor authentication</p>
    
    <!-- Two-Factor Authentication Section -->
    <div class="security-section">
        <h2>🛡️ Two-Factor Authentication (2FA)</h2>
        
        {% if two_fa and two_fa.is_enabled %}
            <!-- 2FA is enabled -->
            <div class="tfa-status enabled">
                <div class="status-icon">🔒</div>
                <div class="status-content">
                    <h3>Two-Factor Authentication is Enabled</h3>
                    <p>Your account is protected with an additional layer of security.</p>
                    <p><strong>Email:</strong> {{ current_user.email }}</p>
                    <p><strong>Enabled on:</strong> {{ two_fa.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    {% if two_fa.last_used %}
                        <p><strong>Last used:</strong> {{ two_fa.last_used.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="tfa-actions">
                <a href="{{ url_for('simple_google_auth.disable_2fa') }}" class="btn btn-danger">Disable 2FA</a>
                <button onclick="showBackupCodes()" class="btn btn-info">View Backup Codes</button>
            </div>
            
            <!-- Backup Codes Section (hidden by default) -->
            <div id="backup-codes-section" class="backup-codes-section" style="display: none;">
                <h4>🔑 Backup Codes</h4>
                <div class="backup-codes-warning">
                    <p><strong>⚠️ Important:</strong> These backup codes can be used if you lose access to your email. Each code can only be used once.</p>
                </div>
                {% if two_fa.backup_codes %}
                    <div class="backup-codes-grid">
                        {% for code in two_fa.backup_codes.split(',') %}
                            {% if code.strip() %}
                                <div class="backup-code">{{ code.strip() }}</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <button onclick="copyBackupCodes()" class="btn btn-secondary">Copy All Codes</button>
                {% endif %}
            </div>
        {% else %}
            <!-- 2FA is not enabled -->
            <div class="tfa-status disabled">
                <div class="status-icon">🔓</div>
                <div class="status-content">
                    <h3>Two-Factor Authentication is Disabled</h3>
                    <p>Enable 2FA to add an extra layer of security to your account.</p>
                    <p><strong>Email for 2FA:</strong> {{ current_user.email }}</p>
                </div>
            </div>
            
            <div class="tfa-benefits">
                <h4>Benefits of Two-Factor Authentication:</h4>
                <ul>
                    <li>🔐 <strong>Enhanced Security:</strong> Protects your account even if your password is compromised</li>
                    <li>📧 <strong>Email-Based:</strong> Receive security codes directly in your email</li>
                    <li>🔑 <strong>Backup Codes:</strong> Access your account even if you can't receive emails</li>
                    <li>🛡️ <strong>Peace of Mind:</strong> Know your personal information is extra secure</li>
                </ul>
            </div>
            
            <div class="tfa-actions">
                <a href="{{ url_for('simple_google_auth.enable_2fa') }}" class="btn btn-success">Enable Two-Factor Authentication</a>
                <a href="{{ url_for('auth.test_2fa') }}" class="btn btn-secondary">Test Email Delivery</a>
            </div>
        {% endif %}
    </div>

    <div class="section-divider"></div>
    
    <!-- Password Security Section -->
    <div class="security-section">
        <h2>🔑 Password Security</h2>
        <div class="password-info">
            <div class="password-status">
                <div class="status-icon">🔐</div>
                <div class="status-content">
                    <h3>Password Settings</h3>
                    <p><strong>Last changed:</strong> {{ current_user.updated_at.strftime('%B %d, %Y') if current_user.updated_at else 'Never' }}</p>
                    <p>Regular password changes help keep your account secure.</p>
                </div>
            </div>
        </div>
        <div class="password-actions">
            <a href="{{ url_for('auth.change_password') }}" class="btn btn-primary">Change Password</a>
            <a href="{{ url_for('auth.forgot_password') }}" class="btn btn-secondary">Reset Password</a>
        </div>
    </div>

    <div class="section-divider"></div>
    
    <!-- Account Activity Section -->
    <div class="security-section">
        <h2>📊 Account Activity</h2>
        <div class="activity-info">
            <div class="activity-item">
                <strong>Account created:</strong> {{ current_user.created_at.strftime('%B %d, %Y') }}
            </div>
            <div class="activity-item">
                <strong>Last login:</strong> {{ current_user.last_login.strftime('%B %d, %Y at %I:%M %p') if current_user.last_login else 'This session' }}
            </div>
            <div class="activity-item">
                <strong>Failed login attempts:</strong> {{ current_user.failed_login_attempts or 0 }}
            </div>
            <div class="activity-item">
                <strong>Email verified:</strong> {{ 'Yes' if current_user.email_verified else 'No' }}
            </div>
        </div>
    </div>
    
    <!-- Security Tips Section -->
    <div class="security-section tips-section">
        <h2>💡 Security Tips</h2>
        <div class="tips-grid">
            <div class="tip-card">
                <div class="tip-icon">🔐</div>
                <h4>Use Strong Passwords</h4>
                <p>Create passwords with at least 8 characters including uppercase, lowercase, numbers, and special characters.</p>
            </div>
            <div class="tip-card">
                <div class="tip-icon">🛡️</div>
                <h4>Enable 2FA</h4>
                <p>Two-factor authentication provides an extra layer of security for your account.</p>
            </div>
            <div class="tip-card">
                <div class="tip-icon">📧</div>
                <h4>Verify Emails</h4>
                <p>Always verify that security emails are legitimate before clicking any links.</p>
            </div>
            <div class="tip-card">
                <div class="tip-icon">🔄</div>
                <h4>Regular Updates</h4>
                <p>Keep your browser and devices updated with the latest security patches.</p>
            </div>
        </div>
    </div>
</div>

<style>
.security-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
}

.security-container h1 {
    color: var(--primary-color);
    text-align: center;
    margin-bottom: 10px;
    font-size: 36px;
}

.security-subtitle {
    text-align: center;
    color: #666;
    margin-bottom: 40px;
    font-size: 18px;
}

.security-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.security-section h2 {
    color: var(--primary-color);
    margin-bottom: 25px;
    font-size: 24px;
    border-bottom: 2px solid var(--light-bg);
    padding-bottom: 10px;
}

.section-divider {
    height: 3px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    margin: 30px 0;
    border-radius: 2px;
}

/* Status Cards */
.tfa-status, .password-status {
    display: flex;
    align-items: center;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
}

.tfa-status.enabled, .password-status {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-left: 5px solid var(--success-color);
}

.tfa-status.disabled {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-left: 5px solid #6c757d;
}

.status-icon {
    font-size: 48px;
    margin-right: 20px;
    flex-shrink: 0;
}

.status-content h3 {
    margin: 0 0 10px 0;
    color: var(--dark-text);
    font-size: 20px;
}

.status-content p {
    margin: 5px 0;
    color: #555;
    font-size: 16px;
}

/* Benefits List */
.tfa-benefits {
    background: var(--light-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
}

.tfa-benefits h4 {
    color: var(--primary-color);
    margin-bottom: 15px;
}

.tfa-benefits ul {
    list-style: none;
    padding: 0;
}

.tfa-benefits li {
    padding: 8px 0;
    font-size: 16px;
    line-height: 1.5;
}

/* Action Buttons */
.tfa-actions, .password-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

/* Backup Codes */
.backup-codes-section {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.backup-codes-section h4 {
    color: #856404;
    margin-bottom: 15px;
}

.backup-codes-warning {
    background: #f8d7da;
    border-left: 4px solid var(--danger-color);
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}

.backup-codes-warning p {
    margin: 0;
    color: #721c24;
    font-weight: 500;
}

.backup-codes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.backup-code {
    background: white;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    text-align: center;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.backup-code:hover {
    background: #e9ecef;
    border-color: var(--primary-color);
}

/* Password Info */
.password-info {
    margin-bottom: 25px;
}

/* Activity Info */
.activity-info {
    background: var(--light-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.activity-item {
    padding: 8px 0;
    border-bottom: 1px solid #dee2e6;
    font-size: 16px;
}

.activity-item:last-child {
    border-bottom: none;
}

/* Security Tips */
.tips-section {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

.tips-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.tip-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.tip-card:hover {
    transform: translateY(-5px);
}

.tip-icon {
    font-size: 40px;
    margin-bottom: 15px;
}

.tip-card h4 {
    color: var(--primary-color);
    margin-bottom: 10px;
    font-size: 18px;
}

.tip-card p {
    color: #666;
    font-size: 14px;
    line-height: 1.5;
}

/* Responsive Design */
@media (max-width: 768px) {
    .security-container {
        padding: 20px 10px;
    }
    
    .tfa-status, .password-status {
        flex-direction: column;
        text-align: center;
    }
    
    .status-icon {
        margin-right: 0;
        margin-bottom: 15px;
    }
    
    .tfa-actions, .password-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .tfa-actions .btn, .password-actions .btn {
        width: 100%;
        text-align: center;
    }
    
    .tips-grid {
        grid-template-columns: 1fr;
    }
    
    .backup-codes-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<script>
function showBackupCodes() {
    const section = document.getElementById('backup-codes-section');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
    } else {
        section.style.display = 'none';
    }
}

function copyBackupCodes() {
    const codes = [];
    document.querySelectorAll('.backup-code').forEach(function(element) {
        codes.push(element.textContent.trim());
    });
    
    const codesText = codes.join('\n');
    
    // Try to copy to clipboard
    if (navigator.clipboard) {
        navigator.clipboard.writeText(codesText).then(function() {
            showToast('✅ Backup codes copied to clipboard!');
        }).catch(function() {
            // Fallback for older browsers
            fallbackCopy(codesText);
        });
    } else {
        fallbackCopy(codesText);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showToast('✅ Backup codes copied to clipboard!');
    } catch (err) {
        alert('Could not copy codes automatically. Please manually copy:\n\n' + text);
    }
    
    document.body.removeChild(textArea);
}

function showToast(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    `;
    
    // Add animation keyframes if not already added
    if (!document.getElementById('toast-styles')) {
        const style = document.createElement('style');
        style.id = 'toast-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // Remove toast after 3 seconds
    setTimeout(function() {
        if (toast.parentNode) {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(function() {
                if (toast.parentNode) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }
    }, 3000);
}

// Add click functionality to individual backup codes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.backup-code').forEach(function(codeElement) {
        codeElement.addEventListener('click', function() {
            const code = this.textContent.trim();
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(function() {
                    showToast(`📋 Code "${code}" copied!`);
                });
            } else {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = code;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showToast(`📋 Code "${code}" copied!`);
                } catch (err) {
                    showToast('❌ Could not copy code');
                }
                
                document.body.removeChild(textArea);
            }
        });
    });
});
</script>
{% endblock %}