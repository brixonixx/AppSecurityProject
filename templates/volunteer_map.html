{% extends "base.html" %}

{% block title %}Volunteer Requests Map{% endblock %}

{% block content %}
<h1>Volunteer Requests Map</h1>

<div id="map" style="height: 400px; width: 100%;"></div>

<div class="mt-3">
  <button id="openHelpBtn" class="btn btn-primary" disabled>Send Help</button>
  <p id="locationStatus" class="text-muted small mt-2"></p>
</div>

<!-- Send Help Modal -->
<div id="helpModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="helpForm" method="POST" action="{{ url_for('volunteer_map') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Send Help Location</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="request_id" id="request_id" />
          <div class="form-group">
            <label for="lat">Latitude</label>
            <input type="text" readonly required class="form-control" name="lat" id="lat" />
          </div>
          <div class="form-group">
            <label for="lng">Longitude</label>
            <input type="text" readonly required class="form-control" name="lng" id="lng" />
          </div>
          <p id="locationStatusModal" class="text-muted small"></p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Submit</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const map = L.map('map').setView([1.3521, 103.8198], 11);
      const openHelpBtn = document.getElementById('openHelpBtn');
      const requestIdInput = document.getElementById('request_id');
      const latInput = document.getElementById('lat');
      const lngInput = document.getElementById('lng');
      const locationStatus = document.getElementById('locationStatus');
      const locationStatusModal = document.getElementById('locationStatusModal');
      let selectedRequestId = null;

      // Add map tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Load volunteer requests and add markers
      fetch('{{ url_for("volunteer_requests_json") }}')
        .then(response => response.json())
        .then(data => {
          data.forEach(request => {
            if (request.lat && request.lng) {
              const marker = L.marker([request.lat, request.lng], {
                icon: L.icon({
                  iconUrl: request.claimed_by
                    ? 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                    : 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41]
                })
              }).addTo(map);

              marker.bindPopup(`<b>${request.title}</b><br>${request.description}`);

              marker.on('click', () => {
                selectedRequestId = request.id;
                requestIdInput.value = selectedRequestId;

                if (!request.claimed_by) {
                  openHelpBtn.disabled = false;
                  openHelpBtn.textContent = `Send Help for "${request.title}"`;
                } else {
                  openHelpBtn.disabled = true;
                  openHelpBtn.textContent = "Already Claimed";
                }
              });
            }
          });
        });

      // Handle Send Help button click
      openHelpBtn.addEventListener('click', () => {
        if (!selectedRequestId) return;

        if (!navigator.geolocation) {
          locationStatus.textContent = 'Geolocation is not supported by your browser.';
          latInput.value = '';
          lngInput.value = '';
          locationStatusModal.textContent = 'Please enter location manually.';
          $('#helpModal').modal('show');
          return;
        }

        locationStatus.textContent = 'Locatingâ€¦ please allow location access.';

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);

            latInput.value = lat;
            lngInput.value = lng;
            locationStatus.textContent = `Location found: (${lat}, ${lng})`;
            locationStatusModal.textContent = '';
            $('#helpModal').modal('show');
          },
          () => {
            locationStatus.textContent = 'Unable to retrieve your location.';
            latInput.value = '';
            lngInput.value = '';
            locationStatusModal.textContent = 'Please enter location manually.';
            $('#helpModal').modal('show');
          }
        );
      });
    });
  </script>
{% endblock %}
