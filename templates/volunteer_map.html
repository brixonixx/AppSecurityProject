{% extends "base.html" %}
{% block title %}Volunteer Map{% endblock %}

{% block content %}
<h1>Volunteer Map</h1>
<div id="map" style="height: 400px; width: 100%; border: 1px solid #ccc;"></div>
<p id="status" class="text-muted mt-2"></p>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Volunteer map initializing...');
      
      let map;
      try {
        // Wait for Leaflet to be fully loaded
        if (typeof L === 'undefined') {
          console.error('Leaflet library not loaded');
          document.getElementById('status').textContent = "Map library failed to load";
          return;
        }
        
        map = L.map('map').setView([1.3521, 103.8198], 11);
        console.log('Map created successfully');
      } catch (error) {
        console.error('Error creating map:', error);
        document.getElementById('status').textContent = "Error initializing map: " + error.message;
        return;
      }

      const markers = {};
      const status = document.getElementById('status');

      try {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
        console.log('Tile layer added');
        
        // Force map to resize after initialization
        setTimeout(() => {
          map.invalidateSize();
        }, 100);
        
      } catch (error) {
        console.error('Error adding tile layer:', error);
        status.textContent = "Error loading map tiles: " + error.message;
      }

      function addMarker(request) {
        const marker = L.marker([request.lat, request.lng]).addTo(map);
        
        // Enhanced popup with more information and actions
        let popupContent = `<b>${request.title}</b><br>${request.description}`;
        
        if (request.requester) {
          popupContent += `<br><small class="text-info">Requested by: ${request.requester}</small>`;
        }
        
        if (request.claimed_by) {
          popupContent += `<br><small class="text-warning">Claimed by: ${request.claimed_by}</small>`;
        }
        
        // Add action buttons for volunteers
        if (request.can_go) {
          popupContent += `<br><div class="mt-2">`;
          
          if (!request.claimed_by) {
            popupContent += `<button class="btn btn-warning btn-sm me-1" onclick="claimRequest(${request.id})">Claim</button>`;
          }
          
          popupContent += `<button class="btn btn-success btn-sm" onclick="goToRequest(${request.id})">Go To</button>`;
          
          // Allow deletion of own requests
          if (request.is_owner) {
            popupContent += `<button class="btn btn-danger btn-sm ms-1" onclick="deleteRequest(${request.id})">Delete</button>`;
          }
          
          popupContent += `</div>`;
        }
        
        marker.bindPopup(popupContent);
        markers[request.id] = marker;
      }

      // Load and display help requests
      console.log('Fetching help requests...');
      const requestsUrl = '{{ url_for("volunteer.volunteer_requests_json") }}';
      console.log('Requests URL:', requestsUrl);
      
      fetch(requestsUrl)
        .then(res => {
          console.log('Response status:', res.status);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          return res.json();
        })
        .then(data => {
          console.log('Received data:', data);
          if (!Array.isArray(data)) {
            throw new Error('Invalid data format received');
          }
          
          if (data.length === 0) {
            status.textContent = "No help requests currently active.";
          } else {
            status.textContent = `Showing ${data.length} help request(s).`;
            data.forEach(req => {
              if (req.lat && req.lng) {
                addMarker(req);
              } else {
                console.warn('Request missing coordinates:', req);
              }
            });
          }
        })
        .catch(error => {
          console.error('Error fetching requests:', error);
          status.textContent = "Error loading help requests: " + error.message;
        });

      // Go to request function with proper error handling
      window.goToRequest = function (requestId) {
        if (!confirm("Do you want to accept this request and remove it?")) return;
        
        fetch(`{{ url_for('volunteer.volunteer_go_to_request', request_id=0) }}`.replace('0', requestId), { 
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            if (markers[requestId]) {
              map.removeLayer(markers[requestId]);
              delete markers[requestId];
            }
            status.textContent = "You accepted the request!";
            
            // Update the status message count
            const remainingCount = Object.keys(markers).length;
            if (remainingCount === 0) {
              status.textContent += " No more requests available.";
            } else {
              status.textContent += ` ${remainingCount} request(s) remaining.`;
            }
          } else {
            status.textContent = result.error || "Failed to accept request.";
          }
        })
        .catch(error => {
          console.error('Error accepting request:', error);
          status.textContent = "Error accepting request.";
        });
      };

      // Claim request function with proper JSON handling
      window.claimRequest = function (requestId) {
        if (!confirm("Do you want to claim this request?")) return;
        
        fetch(`{{ url_for('volunteer.claim_volunteer_request', request_id=0) }}`.replace('0', requestId), { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            status.textContent = "Request claimed! Refreshing map...";
            // Refresh the page to show updated claim status
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            status.textContent = result.error || "Failed to claim request.";
          }
        })
        .catch(error => {
          console.error('Error claiming request:', error);
          status.textContent = "Error claiming request.";
        });
      };

      // Delete request function with proper JSON handling
      window.deleteRequest = function (requestId) {
        if (!confirm("Are you sure you want to delete your help request?")) return;
        
        fetch(`{{ url_for('volunteer.delete_volunteer_request', request_id=0) }}`.replace('0', requestId), { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            if (markers[requestId]) {
              map.removeLayer(markers[requestId]);
              delete markers[requestId];
            }
            status.textContent = "Your request has been deleted.";
            
            // Update the status message count
            const remainingCount = Object.keys(markers).length;
            if (remainingCount === 0) {
              status.textContent += " No more requests available.";
            } else {
              status.textContent += ` ${remainingCount} request(s) remaining.`;
            }
          } else {
            status.textContent = result.error || "Failed to delete request.";
          }
        })
        .catch(error => {
          console.error('Error deleting request:', error);
          status.textContent = "Error deleting request.";
        });
      };
    });
  </script>
{% endblock %}